<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FNAF Guess Who - Visual Architect XL (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        :root { --fnaf-red: #800; --fnaf-bright-red: #f00; --fnaf-bg: #050505; --fnaf-green: #0f0; --fnaf-panel: rgba(15, 15, 15, 0.98); }
        body { 
            background-image: url('background.jpeg'); background-size: cover; background-attachment: fixed;
            background-color: var(--fnaf-bg); color: #e0e0e0; font-family: 'Courier New', monospace; 
            margin: 0; overflow: hidden; user-select: none; 
        }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: -1; }
        #top-left-ctrl { position: fixed; top: 10px; left: 10px; z-index: 3000; display: none; }
        #bottom-left-ctrl { position: fixed; bottom: 10px; left: 10px; z-index: 3000; }
        .tiny-btn { background: rgba(20,20,20,0.8); color: #666; border: 1px solid #333; padding: 5px 10px; font-size: 10px; cursor: pointer; text-transform: uppercase; margin-left: 5px; }
        .tiny-btn:hover { color: #fff; border-color: var(--fnaf-red); }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 2000; }
        .active { display: flex; }
        .menu-box { background: #111; border: 2px solid var(--fnaf-red); padding: 30px; border-radius: 10px; text-align: center; width: 600px; box-shadow: 0 0 30px rgba(128, 0, 0, 0.5); }
        
        /* New Connection Status UI */
        #conn-status { position: fixed; top: 10px; right: 10px; font-size: 10px; color: #444; z-index: 4000; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; }
        .status-online { color: var(--fnaf-green) !important; }
        .status-offline { color: var(--fnaf-red) !important; }

        #sync-overlay, #pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .search-container { margin-bottom: 15px; width: 100%; display: flex; gap: 10px; justify-content: center; position: sticky; top: 0; background: rgba(0,0,0,0.9); z-index: 10; padding: 10px 0; }
        .search-input { background: #000; border: 1px solid #444; color: var(--fnaf-green); padding: 8px; width: 250px; font-family: inherit; font-size: 12px; }
        .jump-select { background: #222; border: 1px solid #444; color: #fff; padding: 8px; font-family: inherit; font-size: 12px; cursor: pointer; }
        
        #editor-wrapper, #board-wrapper { position: absolute; top: 20px; bottom: 120px; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.9); border: 2px solid #333; }
        #editor-wrapper { left: 50px; right: 50px; }
        #board-wrapper { left: 340px; right: 40px; top: 20px; bottom: 20px; }
        
        #editor-grid, #game-board { display: flex; flex-direction: column; gap: 30px; }
        .section-group { border: 1px solid #222; padding: 15px; background: rgba(10,10,10,0.5); }
        .section-header { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--fnaf-red); padding-bottom: 10px; }
        .section-title { color: var(--fnaf-red); margin: 0; font-size: 18px; text-transform: uppercase; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, 180px); gap: 10px; justify-content: center; }
        
        .editor-card { width: 180px; height: 240px; background: #1a1a1a; border: 2px solid #444; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; transition: 0.1s; cursor: cell; }
        .editor-card.enabled { border-color: var(--fnaf-green); background: #020; }
        .editor-card.disabled { opacity: 0.3; filter: grayscale(1); }
        .card-name-tag { font-size: 11px; margin-top: 10px; text-align: center; pointer-events: none; font-weight: bold; }
        .card-img-small { width: 140px; height: 140px; object-fit: contain; pointer-events: none; }
        
        #game-ui { display: none; }
        #target-panel { position: fixed; left: 20px; top: 50%; transform: translateY(-50%); z-index: 1001; background: var(--fnaf-panel); border: 4px solid var(--fnaf-red); border-radius: 15px; padding: 20px; width: 280px; text-align: center; height: 90vh; overflow-y: auto; }
        
        .card { width: 180px; height: 260px; perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; cursor: pointer; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border: 2px solid #444; border-radius: 10px; padding: 10px; box-sizing: border-box; }
        .card-front { background: #1a1a1a; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .card-back { background: var(--fnaf-red); transform: rotateY(180deg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
        
        .menu-btn { background: #222; color: white; border: 1px solid #555; padding: 12px; margin: 5px; cursor: pointer; width: 100%; font-size: 13px; text-transform: uppercase; }
        .menu-btn:hover:not(:disabled) { background: var(--fnaf-red); }
        .menu-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-choose { background: #400; color: #ff9999; border: 2px solid var(--fnaf-red); box-shadow: inset 0 0 10px #f00; text-shadow: 1px 1px #000; font-weight: bold; }
        .btn-guess { background: #030; color: #9f9; border: 2px solid #080; box-shadow: inset 0 0 10px #0f0; text-shadow: 1px 1px #000; font-weight: bold; }
        .data-list { height: 250px; overflow-y: auto; background: #000; border: 1px solid #444; margin-bottom: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; font-size: 12px; }
        .cat-toggle-btn { padding: 4px 8px; font-size: 10px; cursor: pointer; border: 1px solid #444; background: #333; color: #fff; }
        .cat-toggle-btn.on { background: #050; border-color: #0f0; }
        .cat-toggle-btn.off { background: #500; border-color: #f00; }
        .history-ctrl { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
        .highlight-action { outline: 3px solid var(--fnaf-green); outline-offset: 5px; z-index: 50; }
    </style>
</head>
<body onmouseup="stopDragSelect()">
<audio id="bg-audio" loop><source src="background-music.mp3" type="audio/mpeg"></audio>
<audio id="sfx-btn"><source src="button.mp3" type="audio/mpeg"></audio>

<div id="conn-status">PEER: DISCONNECTED</div>

<div id="sync-overlay"><div class="menu-box"><h2 style="color: var(--fnaf-green);">SYNCING DATA...</h2><p>WAITING FOR THE OTHER PLAYER TO CHOOSE THEIR ANIMATRONIC.</p></div></div>
<div id="pause-overlay"><div class="menu-box"><h2 style="color: #ff0;">CONNECTION LOST</h2><p id="pause-msg">WAITING FOR OPPONENT TO RECONNECT...</p></div></div>
<div id="top-left-ctrl">
    <button id="main-menu-btn" class="tiny-btn" onclick="goHome()">MAIN MENU</button>
    <button id="logout-btn" class="tiny-btn" onclick="logout()">LOGOUT</button>
</div>
<div id="bottom-left-ctrl"><button class="tiny-btn" onclick="factoryReset()">FACTORY RESET</button></div>

<div id="screen-login" class="screen active"><div class="menu-box"><h1 style="color: var(--fnaf-red);">FNAF GUESS WHO</h1><input type="text" id="username-input" style="background:#000; border:1px solid #444; color:var(--fnaf-green); padding:10px; text-align:center;" placeholder="ENTER USERNAME"><button class="menu-btn" onclick="confirmLogin()">ENTER TERMINAL</button></div></div>
<div id="screen-main" class="screen"><div class="menu-box"><h2 id="welcome-msg" style="color: var(--fnaf-green);">WELCOME</h2><div id="reconnect-prompt" style="display:none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--fnaf-green);"><p id="resume-text" style="font-size: 12px; color: #fff;">UNFINISHED MATCH DETECTED.</p><button class="menu-btn" style="background: #040;" onclick="resumeSession()">RECONNECT TO GAME</button><button class="menu-btn" style="font-size: 10px; height: 30px; padding: 0;" onclick="clearSession()">DISCARD SESSION</button></div><button class="menu-btn" onclick="showScreen('screen-join')">JOIN ROOM</button><button class="menu-btn" onclick="hostRoom()">HOST ROOM</button><button class="menu-btn" onclick="openBoardManager()">BOARDS EDITOR</button></div></div>
<div id="screen-join" class="screen"><div class="menu-box"><h2 style="color: var(--fnaf-red);">JOIN ROOM</h2><p style="font-size: 10px; color: #666; margin-bottom: 10px;">ENTER YOUR FRIEND'S EXACT USERNAME</p><input type="text" id="join-room-id" style="background:#000; border:1px solid #444; color:var(--fnaf-green); padding:10px; width:80%;" placeholder="FRIEND'S USERNAME"><button class="menu-btn" onclick="connectToPeer()">CONNECT</button><button class="menu-btn" onclick="showScreen('screen-main')">BACK</button></div></div>
<div id="screen-lobby" class="screen"><div class="menu-box"><h2 id="lobby-title" style="color: var(--fnaf-red);">LOBBY</h2><div id="player-roster" class="data-list"></div><div id="host-controls" style="display:none;"><select id="lobby-board-select" style="width:100%; background:#222; color:white; padding:10px; margin-bottom:20px;"></select><button class="menu-btn" id="start-btn" onclick="signalStart()">START MATCH</button></div><div id="guest-waiting" style="display:none; color: #666; font-size: 12px; margin-bottom: 20px;">WAITING FOR HOST TO START...</div><button class="menu-btn" onclick="disconnect()">DISCONNECT</button></div></div>
<div id="screen-boards" class="screen"><div class="menu-box"><h2 style="color: var(--fnaf-red);">YOUR BOARDS</h2><div id="board-list" class="data-list"></div><input type="text" id="new-board-name" style="background:#000; border:1px solid #444; color:var(--fnaf-green); padding:10px;" placeholder="NEW NAME"><button class="menu-btn" onclick="createNewBoard()">CREATE NEW</button><button class="menu-btn" onclick="showScreen('screen-main')">BACK</button></div></div>

<div id="screen-editor" class="screen">
    <div id="editor-wrapper" onmouseleave="stopDragSelect()">
        <h2 id="editing-title" style="color: var(--fnaf-red); text-align:center;">BOARD EDITOR</h2>
        <div class="search-container">
            <input type="text" id="editor-search" class="search-input" placeholder="SEARCH ANIMATRONIC..." oninput="renderVisualEditor()">
            <select id="section-jump" class="jump-select" onchange="jumpToSection(this.value, 'editor-grid')">
                <option value="">JUMP TO...</option>
                <option value="fnaf1">FNAF 1</option>
                <option value="fnaf2">FNAF 2</option>
                <option value="fnaf3">FNAF 3</option>
                <option value="fnaf4">FNAF 4</option>
                <option value="sl">SISTER LOCATION</option>
                <option value="ffps">PIZZERIA SIM</option>
                <option value="sb">SECURITY BREACH</option>
                <option value="hw">HELP WANTED 1/2</option>
                <option value="other">UCN / OTHER</option>
            </select>
        </div>
        <div id="editor-grid"></div>
    </div>
    <div style="position:fixed; bottom:20px; width:100%; display:flex; justify-content:center; gap:10px;">
        <button class="menu-btn" style="width:140px; font-size:10px;" onclick="bulkToggle(true)">SELECT ALL</button>
        <button class="menu-btn" style="width:140px; font-size:10px;" onclick="bulkToggle(false)">DESELECT ALL</button>
        <button class="menu-btn" style="width:200px;" onclick="saveEditor()">SAVE BOARD</button>
    </div>
</div>

<div id="screen-game-over" class="screen">
    <div class="menu-box" style="width: 800px;">
        <div id="end-result-banner" class="result-text">---</div>
        <div class="end-grid">
            <div class="end-side">
                <div style="color: #888; font-size: 10px; margin-bottom: 10px;">LAST GUESS BY <span id="end-guesser-name">---</span></div>
                <img id="end-guess-img" class="end-img" src="">
                <div id="end-guess-name" style="font-weight: bold;">---</div>
            </div>
            <div class="end-side">
                <div style="color: #888; font-size: 10px; margin-bottom: 10px;">ACTUAL TARGETS</div>
                <div style="display: flex; justify-content: space-around;">
                    <div>
                        <div id="end-p1-label" style="font-size: 10px; color: var(--fnaf-green);">YOU</div>
                        <img id="end-p1-img" style="width: 80px; height: 80px; object-fit: contain;">
                        <div id="end-p1-name" style="font-size: 10px;">---</div>
                    </div>
                    <div>
                        <div id="end-p2-label" style="font-size: 10px; color: var(--fnaf-red);">OPPONENT</div>
                        <img id="end-p2-img" style="width: 80px; height: 80px; object-fit: contain;">
                        <div id="end-p2-name" style="font-size: 10px;">---</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="menu-btn" style="margin-top: 30px;" onclick="showScreen('screen-lobby')">BACK TO ROOM</button>
    </div>
</div>

<div id="game-ui">
    <div id="target-panel">
        <div id="user-tag" style="color:var(--fnaf-green); font-size:12px; margin-bottom:10px;">---</div>
        <div id="game-status" style="margin-bottom:10px; font-size:10px; color:#ff0; text-transform:uppercase;">SELECT YOUR ANIMATRONIC</div>
        <div id="target-display" style="width:240px; height:240px; background:#000; border:1px solid #444; display:flex; align-items:center; justify-content:center; border-radius:8px; padding:10px; font-size: 12px; flex-direction: column;">CHOOSING...</div>
        
        <div class="history-ctrl">
            <button id="undo-btn" class="tiny-btn" onclick="undo()" disabled>UNDO</button>
            <button id="redo-btn" class="tiny-btn" onclick="redo()" disabled>REDO</button>
        </div>

        <div id="audio-ctrl" style="margin-top: 15px; padding: 10px; border-top: 1px solid #333;">
            <div style="font-size: 10px; color: #666; margin-bottom: 5px;">SYSTEM VOLUME</div>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.2" style="width: 100%; accent-color: var(--fnaf-red); cursor: pointer;" oninput="updateVolume(this.value)">
        </div>

        <div class="search-container" style="margin-top:10px; flex-direction:column; background:transparent;">
            <input type="text" id="match-search" class="search-input" style="width:240px;" placeholder="SEARCH..." oninput="refreshMatchBoard()">
            <select id="match-jump" class="jump-select" style="width:240px; margin-top:5px;" onchange="jumpToSection(this.value, 'game-board')">
                <option value="">JUMP TO...</option>
            </select>
        </div>
        <button id="invert-btn" class="menu-btn" style="width:240px; font-size:11px; margin-top:10px; display:none;" onclick="invertFlippedCards()">INVERT FLIPPED</button>
    </div>
    <div id="board-wrapper"><div id="game-board"></div></div>
</div>

<script>
    const categories = [
        { id: "fnaf1", title: "FNAF 1", range: [0, 8] },
        { id: "fnaf2", title: "FNAF 2", range: [9, 23] },
        { id: "fnaf3", title: "FNAF 3", range: [24, 30] },
        { id: "fnaf4", title: "FNAF 4", range: [31, 44] },
        { id: "sl", title: "SISTER LOCATION", range: [45, 58] },
        { id: "ffps", title: "PIZZERIA SIM", range: [59, 77] },
        { id: "other", title: "UCN / OTHER", range: [78, 82] },
        { id: "sb", title: "SECURITY BREACH", range: [83, 98] },
        { id: "hw", title: "HELP WANTED 1/2", range: [99, 103] }
    ];

    const animData = [
        {name: "Freddy Fazbear", img: "Freddy Fazbear.webp"}, {name: "Bonnie", img: "Bonnie.webp"}, {name: "Chica", img: "Chica.webp"}, {name: "Foxy", img: "Foxy.webp"}, {name: "Golden Freddy", img: "Golden Freddy.webp"}, {name: "Phone Guy", img: "Phone Guy.webp"}, {name: "Mr. Cupcake", img: "Mr. Cupcake.webp"}, {name: "Desk Fan", img: "Desk Fan.webp"}, {name: "Endo-01", img: "Endo-01.webp"},
        {name: "Toy Freddy", img: "Toy Freddy.webp"}, {name: "Toy Bonnie", img: "Toy Bonnie.webp"}, {name: "Toy Chica", img: "Toy Chica.webp"}, {name: "Toy Mangle", img: "Toy Mangle.webp"}, {name: "Toy Cupcake", img: "Toy Cupcake.webp"}, {name: "Balloon Boy", img: "Balloon Boy.webp"}, {name: "Jay Jay", img: "Jay Jay.webp"}, {name: "Marionette", img: "Marionette.webp"}, {name: "Withered Freddy", img: "Withered Freddy.webp"}, {name: "Withered Bonnie", img: "Withered Bonnie.webp"}, {name: "Withered Chica", img: "Withered Chica.webp"}, {name: "Withered Foxy", img: "Withered Foxy.webp"}, {name: "Shadow Freddy", img: "Shadow Freddy.webp"}, {name: "Shadow Bonnie", img: "Shadow Bonnie.webp"}, {name: "Endo-02", img: "Endo-02.webp"},
        {name: "Springtrap", img: "Springtrap.webp"}, {name: "Phantom Freddy", img: "Phantom Freddy.webp"}, {name: "Phantom Chica", img: "Phantom Chica.webp"}, {name: "Phantom Foxy", img: "Phantom Foxy.webp"}, {name: "Phantom Mangle", img: "Phantom Mangle.webp"}, {name: "Phantom Balloon Boy", img: "Phantom Balloon Boy.webp"}, {name: "Phantom Puppet", img: "Phantom Puppet.webp"},
        {name: "Nightmare Freddy", img: "Nightmare Freddy.webp"}, {name: "Nightmare Bonnie", img: "Nightmare Bonnie.webp"}, {name: "Nightmare Chica", img: "Nightmare Chica.webp"}, {name: "Nightmare Foxy", img: "Nightmare Foxy.webp"}, {name: "Nightmare Fredbear", img: "Nightmare Fredbear.webp"}, {name: "Nightmare", img: "Nightmare.webp"}, {name: "Plushtrap", img: "Plushtrap.webp"}, {name: "Freddles", img: "Freddles.webp"}, {name: "Nightmare Cupcake", img: "Nightmare Cupcake.webp"}, {name: "Jack-O-Bonnie", img: "Jack-O-Bonnie.webp"}, {name: "Jack-O-Chica", img: "Jack-O-Chica.webp"}, {name: "Nightmare Mangle", img: "Nightmare Mangle.webp"}, {name: "Nightmarionne", img: "Nightmarionne.webp"}, {name: "Nightmare Balloon Boy", img: "Nightmare Balloon Boy.webp"},
        {name: "Circus Baby", img: "Circus Baby.webp"}, {name: "Ballora", img: "Ballora.webp"}, {name: "Funtime Freddy", img: "Funtime Freddy.webp"}, {name: "Funtime Foxy", img: "Funtime Foxy.webp"}, {name: "Ennard", img: "Ennard.webp"}, {name: "Bidybab", img: "Bidybab.webp"}, {name: "Minireenas", img: "Minireenas.webp"}, {name: "Bon-Bon", img: "Bon-Bon.webp"}, {name: "Bonnet", img: "Bonnet.webp"}, {name: "Lolbit", img: "Lolbit.webp"}, {name: "Yenndo", img: "Yenndo.webp"}, {name: "Funtime Cupcake", img: "Funtime Cupcake.webp"}, {name: "Casual Bongos", img: "Casual Bongos.webp"}, {name: "Exotic Butters", img: "Exotic Butters.webp"},
        {name: "Helpy", img: "Helpy.webp"}, {name: "Scrap Baby", img: "Scrap Baby.webp"}, {name: "ScrapTrap", img: "ScrapTrap.webp"}, {name: "Molten Freddy", img: "Molten Freddy.webp"}, {name: "Lefty", img: "Lefty.webp"}, {name: "Rockstar Freddy", img: "Rockstar Freddy.webp"}, {name: "Rockstar Bonnie", img: "Rockstar Bonnie.webp"}, {name: "Rockstar Chica", img: "Rockstar Chica.webp"}, {name: "Rockstar Foxy", img: "Rockstar Foxy.webp"}, {name: "Happy Frog", img: "Happy Frog.webp"}, {name: "Mr. Hippo", img: "Mr. Hippo.webp"}, {name: "Pigpatch", img: "Pigpatch.webp"}, {name: "Nedd Bear", img: "Nedd Bear.webp"}, {name: "Orville Elephant", img: "Orville Elephant.webp"}, {name: "Music Man", img: "Music Man.webp"}, {name: "El Chip", img: "El Chip.webp"}, {name: "Funtime Chica", img: "Funtime Chica.webp"}, {name: "Candy Cadet", img: "Candy Cadet.webp"}, {name: "Trash And The Gang", img: "Trash And The Gang.webp"},
        {name: "Dee Dee", img: "Dee Dee.webp"}, {name: "Shadow Dee Dee", img: "Shadow Dee Dee.webp"}, {name: "Old Man Consequences", img: "Old Man Consequences.webp"}, {name: "Fredbear", img: "Fredbear.webp"}, {name: "Spring Bonnie", img: "Spring Bonnie.webp"},
        {name: "Glamrock Freddy", img: "Glamrock Freddy.webp"}, {name: "Glamrock Chica", img: "Glamrock Chica.webp"}, {name: "Montgomery Gator", img: "Montgomery Gator.webp"}, {name: "Roxanne Wolf", img: "Roxanne Wolf.webp"}, {name: "Daycare Attendant Sun", img: "Daycare Attendant Sun.webp"}, {name: "Daycare Attendant Moon", img: "Daycare Attendant Moon.webp"}, {name: "Daycare Attendant Eclipse", img: "Daycare Attendant Eclipse.webp"}, {name: "Glamrock Bonnie", img: "Glamrock Bonnie.webp"}, {name: "Glamrock Endo", img: "Glamrock Endo.webp"}, {name: "The Mimic", img: "The Mimic.webp"}, {name: "Blob", img: "Blob.webp"}, {name: "Glitchtrap", img: "Glitchtrap.webp"}, {name: "Faz Wrench", img: "Faz Wrench.webp"}, {name: "Vanny", img: "Vanny.webp"}, {name: "Vanessa", img: "Vanessa.webp"},
        {name: "Mystic Hippo", img: "Mystic Hippo.webp"}, {name: "Carnie", img: "Carnie.webp"}, {name: "Grimm Foxy", img: "Grimm Foxy.webp"}, {name: "Dreadbear", img: "Dreadbear.webp"}, {name: "Plushbabies", img: "Plushbabies.webp"} 
    ];

    const masterRoster = animData.map((data, i) => ({ id: i, name: data.name, img: `Animatronics/${data.img}`, enabled: true }));

    let savedBoards = {};
    let myName = localStorage.getItem('fnaf_user') || "";
    let peer = null, conn = null, isHost = false, roomPlayers = [], activeRoster = [], isDragging = false, dragTargetState = null, lastToggledId = null, myTargetForOpponent = null, opponentTargetForMe = null, currentBoardName = "", currentMatchMode = ""; 
    let flippedCards = new Set();
    let myTargetObj = null;
    let historyStack = [], redoStack = [];

    // GLOBAL PEER CONFIGURATION
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
                { url: 'stun:stun2.l.google.com:19302' },
                { url: 'stun:stun3.l.google.com:19302' },
                { url: 'stun:stun4.l.google.com:19302' }
            ]
        },
        debug: 1 // Reduces console noise while keeping errors
    };

    function updatePeerStatus(status, isError = false) {
        const el = document.getElementById('conn-status');
        el.innerText = `PEER: ${status.toUpperCase()}`;
        el.className = isError ? 'status-offline' : (status === 'connected' ? 'status-online' : '');
    }

    function loadUserData() {
        if(!myName) return;
        const storageKey = `fnaf_boards_${myName}`;
        savedBoards = JSON.parse(localStorage.getItem(storageKey)) || { "Main Roster": [...masterRoster] };
    }

    function saveUserData() {
        if(!myName) return;
        const storageKey = `fnaf_boards_${myName}`;
        localStorage.setItem(storageKey, JSON.stringify(savedBoards));
    }

    function confirmLogin() {
        const input = document.getElementById('username-input').value.trim();
        if(!input) return;
        myName = input;
        localStorage.setItem('fnaf_user', myName);
        loadUserData();
        initSession();
    }

    function initSession() {
        document.getElementById('welcome-msg').innerText = `WELCOME, ${myName}`;
        document.getElementById('top-left-ctrl').style.display = 'block';
        document.getElementById('main-menu-btn').style.display = 'none';
        showScreen('screen-main');
        checkSession();
    }

    function logout() {
        if(conn || currentMatchMode !== "") {
            if(!confirm("Active game will be lost. Logout?")) return;
            disconnect(true);
        }
        localStorage.removeItem('fnaf_user');
        myName = "";
        document.getElementById('username-input').value = "";
        document.getElementById('top-left-ctrl').style.display = 'none';
        showScreen('screen-login');
    }

    function goHome() {
        if(currentMatchMode !== "") {
            showScreen('game-ui');
        } else {
            showScreen('screen-main');
        }
    }

    window.onload = () => {
        if(myName) {
            loadUserData();
            initSession();
        }
    };

    function saveSession() {
        if(currentMatchMode === "" && !localStorage.getItem('fnaf_active_session')) return;
        const session = {
            isHost,
            activeRoster,
            myTargetForOpponent,
            opponentTargetForMe,
            flippedCards: Array.from(flippedCards),
            myTargetObj,
            hostID: isHost ? (peer ? peer.id : null) : (conn ? conn.peer : null),
            mode: currentMatchMode
        };
        localStorage.setItem('fnaf_active_session', JSON.stringify(session));
    }

    function clearSession() {
        localStorage.removeItem('fnaf_active_session');
        const prompt = document.getElementById('reconnect-prompt');
        if(prompt) prompt.style.display = 'none';
    }

    function checkSession() {
        const sessionStr = localStorage.getItem('fnaf_active_session');
        if(sessionStr) {
            const session = JSON.parse(sessionStr);
            const prompt = document.getElementById('reconnect-prompt');
            const text = document.getElementById('resume-text');
            prompt.style.display = 'block';
            text.innerText = session.isHost ? "YOU WERE HOSTING A MATCH. RESUME?" : "YOU WERE IN A MATCH. REJOIN?";
        }
    }

    function resumeSession() {
        const session = JSON.parse(localStorage.getItem('fnaf_active_session'));
        isHost = session.isHost;
        activeRoster = session.activeRoster;
        myTargetForOpponent = session.myTargetForOpponent;
        opponentTargetForMe = session.opponentTargetForMe;
        flippedCards = new Set(session.flippedCards);
        myTargetObj = session.myTargetObj;
        currentMatchMode = session.mode;

        if(isHost) {
            hostRoom(session.hostID);
        } else {
            connectToPeer(session.hostID);
        }
    }

    function saveHistory(affectedNames = null) {
        historyStack.push({ state: new Set(flippedCards), affected: affectedNames });
        redoStack = [];
        updateHistoryButtons();
        saveSession();
    }

    function jumpToCard(names) {
        if(!names || names.length === 0) return;
        const firstName = Array.isArray(names) ? names[0] : names;
        const target = document.querySelector(`.card[data-name="${firstName}"]`);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-action');
            setTimeout(() => target.classList.remove('highlight-action'), 1000);
        }
    }

    function undo() {
        if (historyStack.length === 0) return;
        const currentData = historyStack.pop();
        redoStack.push({ state: new Set(flippedCards), affected: currentData.affected });
        flippedCards = currentData.state;
        updateHistoryButtons();
        refreshMatchBoard();
        saveSession();
        if(currentData.affected) jumpToCard(currentData.affected);
    }

    function redo() {
        if (redoStack.length === 0) return;
        const nextData = redoStack.pop();
        historyStack.push({ state: new Set(flippedCards), affected: nextData.affected });
        flippedCards = nextData.state;
        updateHistoryButtons();
        refreshMatchBoard();
        saveSession();
        if(nextData.affected) jumpToCard(nextData.affected);
    }

    function updateHistoryButtons() {
        const u = document.getElementById('undo-btn');
        const r = document.getElementById('redo-btn');
        if(u) u.disabled = historyStack.length === 0;
        if(r) r.disabled = redoStack.length === 0;
    }

    function jumpToSection(catId, gridId) {
        if(!catId) return;
        const target = document.getElementById(`section-${catId}-${gridId}`);
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function playBtnSfx() {
        const sfx = document.getElementById('sfx-btn');
        if(sfx) { sfx.currentTime = 0; sfx.play().catch(()=>{}); }
    }

    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) playBtnSfx();
    });

    document.addEventListener('click', () => {
        initAudio();
    }, { once: true });

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screen = document.getElementById(id);
        if(screen) screen.classList.add('active');
        
        const inGame = (id === 'game-ui');
        document.getElementById('game-ui').style.display = inGame ? 'block' : 'none';
        document.getElementById('main-menu-btn').style.display = inGame ? 'inline-block' : 'none';
        
        document.getElementById('sync-overlay').style.display = 'none';
        document.getElementById('pause-overlay').style.display = 'none';
    }

    function hostRoom(existingID = null) {
        if (peer) peer.destroy();
        isHost = true;
        const idToUse = existingID || myName.replace(/\s+/g, '_');
        
        peer = new Peer(idToUse, peerConfig); 
        
        peer.on('open', (id) => {
            updatePeerStatus('online (' + id + ')');
            roomPlayers = [{ name: myName, isHost: true }];
            if(existingID) {
                showScreen('game-ui');
                if(myTargetForOpponent) {
                    lockTarget(myTargetForOpponent, myTargetObj.img);
                } else {
                    renderMatchBoard('choose');
                }
            } else {
                showScreen('screen-lobby');
                document.getElementById('lobby-title').innerText = "HOST ID: " + id;
                renderRoster();
            }
        });

        peer.on('error', (err) => {
            console.error('Peer Error:', err.type);
            if(err.type === 'unavailable-id') {
                alert("This username is already online. Please try a different name.");
                logout();
            }
            updatePeerStatus('Error: ' + err.type, true);
        });

        peer.on('connection', (c) => {
            conn = c;
            updatePeerStatus('connected');
            conn.on('data', (data) => handleData(data));
            conn.on('close', () => { 
                updatePeerStatus('opponent left');
                if(isHost) {
                   document.getElementById('pause-msg').innerText = "OPPONENT DISCONNECTED. WAITING...";
                   document.getElementById('pause-overlay').style.display = 'flex';
                }
            });
            conn.on('open', () => {
                conn.send({ type: 'WELCOME', hostName: myName, inGame: (currentMatchMode !== "") });
            });
        });
    }

    function connectToPeer(existingID = null) {
        if (peer) peer.destroy();
        const targetID = existingID || document.getElementById('join-room-id').value.trim().replace(/\s+/g, '_');
        if(!targetID) return;
        
        peer = new Peer(peerConfig);
        
        peer.on('open', () => {
            updatePeerStatus('searching for host...');
            conn = peer.connect(targetID, { reliable: true });
            
            conn.on('open', () => {
                updatePeerStatus('connected');
                conn.send({ type: 'JOIN', name: myName });
                isHost = false;
                if(!existingID) showScreen('screen-lobby');
            });

            conn.on('data', (data) => handleData(data));
            
            conn.on('error', (err) => {
                alert("Could not connect to friend. Ensure their name is correct.");
                updatePeerStatus('fail', true);
            });

            conn.on('close', () => {
                updatePeerStatus('host left');
                if(!isHost) {
                   document.getElementById('pause-msg').innerText = "HOST DISCONNECTED. WAITING FOR RECOVERY...";
                   document.getElementById('pause-overlay').style.display = 'flex';
                }
            });
        });
    }

    function handleData(data) {
        if(data.type === 'TERMINATE') { clearSession(); handleTermination(data.reason); }
        if(data.type === 'JOIN') { 
            roomPlayers = [{ name: myName, isHost: true }, { name: data.name, isHost: false }]; 
            renderRoster();
            document.getElementById('pause-overlay').style.display = 'none';
        }
        if(data.type === 'WELCOME') { 
            roomPlayers = [{ name: data.hostName, isHost: true }, { name: myName, isHost: false }]; 
            renderRoster(); 
        }
        if(data.type === 'START') { activeRoster = data.roster; resetGameState(); showScreen('game-ui'); renderMatchBoard('choose'); saveSession(); }
        if(data.type === 'TARGET_SET') { opponentTargetForMe = data.target; checkSync(); saveSession(); }
        if(data.type === 'GAME_OVER') { clearSession(); showEndScreen(data.result, data.guesser, data.guessedChar, data.opponentTarget); }
    }

    function handleTermination(reason) { alert(reason); disconnect(true); }

    function signalStart() {
        if(roomPlayers.length < 2) return alert("You need at least 2 players to start a match!");
        const bName = document.getElementById('lobby-board-select').value;
        const roster = savedBoards[bName].filter(c => c.enabled);
        if(roster.length < 2) return alert("Select at least 2 animatronics!");
        if(conn) conn.send({ type: 'START', roster: roster });
        activeRoster = roster;
        resetGameState();
        showScreen('game-ui');
        renderMatchBoard('choose');
    }

    function resetGameState() {
        myTargetForOpponent = null; opponentTargetForMe = null; myTargetObj = null;
        flippedCards.clear(); historyStack = []; redoStack = []; updateHistoryButtons();
        document.getElementById('match-search').value = "";
        document.getElementById('target-display').innerText = "CHOOSING...";
        document.getElementById('user-tag').innerText = myName.toUpperCase();
        document.getElementById('game-status').innerText = "SELECT YOUR ANIMATRONIC";
        document.getElementById('invert-btn').style.display = 'none';
    }

    function refreshMatchBoard() { renderMatchBoard(currentMatchMode); }

    function toggleFlipState(name, cardElement) {
        saveHistory([name]);
        if (flippedCards.has(name)) {
            flippedCards.delete(name);
            cardElement.classList.remove('flipped');
        } else {
            flippedCards.add(name);
            cardElement.classList.add('flipped');
        }
        saveSession();
    }

    function renderMatchBoard(mode) {
        currentMatchMode = mode;
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        const btnClass = mode === 'choose' ? 'menu-btn btn-choose' : 'menu-btn btn-guess';
        const query = document.getElementById('match-search').value.toLowerCase();
        
        const jumpSelect = document.getElementById('match-jump');
        jumpSelect.innerHTML = '<option value="">JUMP TO...</option>';

        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'section-group';
            section.id = `section-${cat.id}-game-board`;
            
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = `
                <h3 class="section-title">${cat.title}</h3>
                <button class="cat-toggle-btn on" onclick="bulkMatchToggle('${cat.id}', false)">OUT ALL</button>
                <button class="cat-toggle-btn off" onclick="bulkMatchToggle('${cat.id}', true)">IN ALL</button>
            `;
            
            const charGrid = document.createElement('div');
            charGrid.className = 'char-grid';
            
            let count = 0;
            const catItems = activeRoster.filter(char => {
                const globalIndex = masterRoster.findIndex(m => m.name === char.name);
                return globalIndex >= cat.range[0] && globalIndex <= cat.range[1];
            });

            catItems.forEach(char => {
                if (query && !char.name.toLowerCase().includes(query)) return;
                count++;
                const card = document.createElement('div');
                card.className = 'card' + (flippedCards.has(char.name) ? ' flipped' : '');
                card.dataset.name = char.name;
                card.innerHTML = `<div class="card-inner"><div class="card-front"><img src="${char.img}" style="width:140px; height:140px; object-fit:contain;" onerror="this.src='https://via.placeholder.com/140/800/fff?text=?'"><div style="font-size:11px; margin-top:5px; font-weight:bold;">${char.name}</div><button class="${btnClass}" style="padding:4px; font-size:10px; margin-top:5px;" onclick="event.stopPropagation(); ${mode==='choose'?`lockTarget('${char.name}', '${char.img}')`:`confirmGuess('${char.name}', '${char.img}')`}">${mode.toUpperCase()}</button></div><div class="card-back">OUT</div></div>`;
                if(mode === 'guess') card.onclick = () => toggleFlipState(char.name, card);
                charGrid.appendChild(card);
            });
            
            if(count > 0) {
                jumpSelect.innerHTML += `<option value="${cat.id}">${cat.title}</option>`;
                section.appendChild(header);
                section.appendChild(charGrid);
                board.appendChild(section);
            }
        });
        updateHistoryButtons();
    }

    function bulkMatchToggle(catId, state) {
        if(!confirm("Are you sure?")) return;
        const cat = categories.find(c => c.id === catId);
        const affected = [];
        activeRoster.forEach(char => {
            const globalIndex = masterRoster.findIndex(m => m.name === char.name);
            if(globalIndex >= cat.range[0] && globalIndex <= cat.range[1]) {
                affected.push(char.name);
            }
        });
        saveHistory(affected);
        affected.forEach(name => {
            if(state) flippedCards.delete(name);
            else flippedCards.add(name);
        });
        refreshMatchBoard();
        saveSession();
    }

    function confirmGuess(name, img) {
        if(confirm(`Is this your final choice? Guessing ${name}?`)) {
            checkWin(name, img);
        }
    }

    function lockTarget(name, img) {
        myTargetForOpponent = name;
        myTargetObj = { name: name, img: img };
        document.getElementById('target-display').innerHTML = `<span style="color:var(--fnaf-red); margin-bottom:10px; font-weight:bold;">YOUR ANIMATRONIC</span><img src="${img}" style="width:160px; height:160px; object-fit:contain;" onerror="this.src='https://via.placeholder.com/160/800/fff?text=?'"><div style="margin-top:10px; font-size:12px; font-weight:bold;">${name}</div>`;
        if(conn) conn.send({ type: 'TARGET_SET', target: name });
        checkSync();
        saveSession();
    }

    function checkSync() {
        if(myTargetForOpponent && opponentTargetForMe) {
            document.getElementById('sync-overlay').style.display = 'none';
            document.getElementById('game-status').innerText = "GUESS OPPONENT'S ANIMATRONIC";
            document.getElementById('invert-btn').style.display = 'block';
            renderMatchBoard('guess');
        } else if (myTargetForOpponent) {
            document.getElementById('sync-overlay').style.display = 'flex';
        }
    }

    function checkWin(name, img) {
        const win = (name === opponentTargetForMe);
        const result = win ? 'VICTORY' : 'DEFEAT';
        const opTargetData = activeRoster.find(c => c.name === opponentTargetForMe);
        if(conn) conn.send({ type: 'GAME_OVER', result: win ? 'DEFEAT' : 'VICTORY', guesser: myName, guessedChar: {name: name, img: img}, opponentTarget: myTargetObj });
        clearSession();
        showEndScreen(result, myName, {name: name, img: img}, opTargetData);
    }

    function showEndScreen(result, guesser, charObj, opTarget) {
        currentMatchMode = "";
        const banner = document.getElementById('end-result-banner');
        if(banner) {
            banner.innerText = result;
            banner.style.color = (result === 'VICTORY') ? '#ff0' : '#f00';
        }
        document.getElementById('end-guesser-name').innerText = guesser.toUpperCase();
        document.getElementById('end-guess-name').innerText = charObj.name;
        document.getElementById('end-guess-img').src = charObj.img;
        document.getElementById('end-p1-img').src = myTargetObj.img;
        document.getElementById('end-p1-name').innerText = myTargetObj.name;
        document.getElementById('end-p2-img').src = opTarget.img;
        document.getElementById('end-p2-name').innerText = opTarget.name;
        showScreen('screen-game-over');
    }

    function disconnect(silent = false) {
        if(isHost && conn && !silent) conn.send({ type: 'TERMINATE', reason: 'HOST LEFT THE GAME' });
        if(!silent) clearSession();
        if(conn) conn.close(); if(peer) peer.destroy(); peer = null; conn = null; showScreen('screen-main');
        currentMatchMode = "";
        updatePeerStatus('disconnected');
        checkSession();
    }

    function renderRoster() {
        const rosterDiv = document.getElementById('player-roster');
        rosterDiv.innerHTML = '';
        roomPlayers.forEach((p) => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<span>${p.name} ${p.isHost ? '<strong style="color:red;">[HOST]</strong>' : ''}</span>`;
            rosterDiv.appendChild(item);
        });
        document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
        document.getElementById('guest-waiting').style.display = isHost ? 'none' : 'block';
        if(isHost) {
            const select = document.getElementById('lobby-board-select');
            select.innerHTML = '';
            Object.keys(savedBoards).forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
        }
    }

    function openBoardManager() { document.getElementById('editor-search').value = ""; showScreen('screen-boards'); renderBoardList(); }

    function renderBoardList() {
        const list = document.getElementById('board-list');
        list.innerHTML = '';
        Object.keys(savedBoards).forEach(name => {
            list.innerHTML += `<div class="list-item">
                <span>${name}</span>
                <div>
                    <button class="tiny-btn" onclick="editBoard('${name}')">EDIT</button>
                    <button class="tiny-btn" onclick="renameBoard('${name}')">RENAME</button>
                    <button class="tiny-btn" style="color:red;" onclick="deleteBoard('${name}')">DELETE</button>
                </div>
            </div>`;
        });
    }

    function renameBoard(oldName) {
        const newName = prompt("Enter new name:", oldName);
        if(newName && newName !== oldName && !savedBoards[newName]) {
            savedBoards[newName] = savedBoards[oldName];
            delete savedBoards[oldName];
            saveUserData();
            renderBoardList();
        }
    }

    function deleteBoard(name) {
        if(Object.keys(savedBoards).length <= 1) return alert("Cannot delete last board!");
        if(confirm(`Delete board '${name}'?`)) {
            delete savedBoards[name];
            saveUserData();
            renderBoardList();
        }
    }

    function createNewBoard() {
        const name = document.getElementById('new-board-name').value.trim();
        if(!name || savedBoards[name]) return;
        savedBoards[name] = masterRoster.map(c => ({...c}));
        saveUserData();
        renderBoardList();
    }

    function editBoard(name) { currentBoardName = name; showScreen('screen-editor'); renderVisualEditor(); }

    function renderVisualEditor() {
        const grid = document.getElementById('editor-grid');
        grid.innerHTML = '';
        const query = document.getElementById('editor-search').value.toLowerCase();
        
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'section-group';
            section.id = `section-${cat.id}-editor-grid`;
            
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = `
                <h3 class="section-title">${cat.title}</h3>
                <button class="cat-toggle-btn on" onclick="toggleCategory('${cat.id}', true)">ENABLE ALL</button>
                <button class="cat-toggle-btn off" onclick="toggleCategory('${cat.id}', false)">DISABLE ALL</button>
            `;
            
            const charGrid = document.createElement('div');
            charGrid.className = 'char-grid';
            
            let count = 0;
            savedBoards[currentBoardName].slice(cat.range[0], cat.range[1] + 1).forEach(char => {
                if (query && !char.name.toLowerCase().includes(query)) return;
                count++;
                const card = document.createElement('div');
                card.className = `editor-card ${char.enabled ? 'enabled' : 'disabled'}`;
                card.dataset.id = char.id;
                card.onmousedown = (e) => { e.preventDefault(); startDragSelect(char.id); };
                card.onmouseenter = () => { if(isDragging) handleToggle(char.id); };
                card.innerHTML = `<img src="${char.img}" class="card-img-small" onerror="this.src='https://via.placeholder.com/160/800/fff?text=?'"><div class="card-name-tag">${char.name}</div>`;
                charGrid.appendChild(card);
            });
            
            if(count > 0) {
                section.appendChild(header);
                section.appendChild(charGrid);
                grid.appendChild(section);
            }
        });
    }

    function toggleCategory(catId, state) {
        const cat = categories.find(c => c.id === catId);
        if(!cat) return;
        for(let i = cat.range[0]; i <= cat.range[1]; i++) {
            savedBoards[currentBoardName][i].enabled = state;
        }
        renderVisualEditor();
    }

    function handleToggle(id) {
        if(lastToggledId === id) return;
        const char = savedBoards[currentBoardName].find(c => c.id === id);
        if(char) {
            char.enabled = dragTargetState;
            lastToggledId = id;
            const card = document.querySelector(`.editor-card[data-id="${id}"]`);
            if(card) card.className = `editor-card ${char.enabled ? 'enabled' : 'disabled'}`;
        }
    }

    function startDragSelect(startId) {
        isDragging = true;
        const char = savedBoards[currentBoardName].find(c => c.id === startId);
        dragTargetState = !char.enabled; 
        lastToggledId = null;
        handleToggle(startId);
    }

    function stopDragSelect() { isDragging = false; dragTargetState = null; lastToggledId = null; }
    function bulkToggle(state) { savedBoards[currentBoardName].forEach(c => c.enabled = state); renderVisualEditor(); }
    function saveEditor() { saveUserData(); openBoardManager(); }
    function factoryReset() { if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }

    function updateVolume(val) {
        const a = document.getElementById('bg-audio');
        if (a) {
            a.volume = val;
            localStorage.setItem('fnaf_volume', val);
        }
    }

    function initAudio() { 
        const a = document.getElementById('bg-audio'); 
        if(a) { 
            const savedVol = localStorage.getItem('fnaf_volume') || 0.2;
            a.volume = savedVol;
            const slider = document.getElementById('volume-slider');
            if(slider) slider.value = savedVol;
            a.play().catch(() => {}); 
        } 
    }

    function invertFlippedCards() { 
        const allNames = activeRoster.map(c => c.name);
        saveHistory(allNames);
        activeRoster.forEach(char => {
            if (flippedCards.has(char.name)) flippedCards.delete(char.name);
            else flippedCards.add(char.name);
        });
        refreshMatchBoard();
        saveSession();
    }
</script>
</body>
</html>